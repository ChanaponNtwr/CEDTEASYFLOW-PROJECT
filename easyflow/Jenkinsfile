pipeline {
    agent any

    environment {
        // Defines the Docker image name and tag
        DOCKER_IMAGE = 'cedt-easyflow'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        REGISTRY_URL = '' // Add your Docker registry URL here if needed
    }

    stages {
        stage('Checkout') {
            steps {
                // Checkout the source code from the repository
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('easyflow') {
                    script {
                        echo "Building Docker image ${DOCKER_IMAGE}:${DOCKER_TAG}..."
                        // Build using the local Docker daemon
                        if (isUnix()) {
                            sh 'docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .'
                            sh 'docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest'
                        } else {
                            // Support for Windows Jenkins agents
                            bat "docker build -t %DOCKER_IMAGE%:%DOCKER_TAG% ."
                            bat "docker tag %DOCKER_IMAGE%:%DOCKER_TAG% %DOCKER_IMAGE%:latest"
                        }
                    }
                }
            }
        }

        stage('Test / Validate') {
            steps {
                dir('easyflow') {
                    script {
                        echo "Running basic tests or validation..."
                        // Place your test scripts here, for example:
                        // sh 'npm run test'
                    }
                }
            }
        }

        stage('Deploy Container') {
            steps {
                script {
                    echo "Deploying Docker container ${DOCKER_IMAGE}:${DOCKER_TAG}..."

                    if (isUnix()) {
                        sh '''
                        docker rm -f cedt-easyflow 2>/dev/null || true
                        docker run -d --name cedt-easyflow -p 3000:3000 ${DOCKER_IMAGE}:${DOCKER_TAG}
                        '''
                    } else {
                        bat """
                        docker rm cedt-easyflow || echo No existing cedt-easyflow container
                        docker run -d --name cedt-easyflow -p 3000:3000 %DOCKER_IMAGE%:%DOCKER_TAG%
                        """
                    }
                }
            }
        }

        /*
        // Optional Step for Push
        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry("https://${REGISTRY_URL}", 'docker-credentials-id') {
                        def img = docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}")
                        img.push()
                        img.push('latest')
                    }
                }
            }
        }
        */
    }

    post {
        always {
            echo "Pipeline finished. Cleaning workspace..."
            cleanWs()
        }
        success {
            echo "Pipeline succeeded!"
        }
        failure {
            echo "Pipeline failed! Please check logs."
        }
    }
}
